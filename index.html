<script>
  const KISHAN_VOICE_ID = 'KSsyodh37PbfWy29kPtx';
  const synth = window.speechSynthesis;

  const textInput = document.getElementById('text-input');
  const languageSelect = document.getElementById('language-select');
  const voiceSelect = document.getElementById('voice-select');
  const rate = document.getElementById('rate');
  const pitch = document.getElementById('pitch');
  const rateVal = document.getElementById('rate-val');
  const pitchVal = document.getElementById('pitch-val');
  const themeCheckbox = document.getElementById('theme-toggle-checkbox');
  const apiKeyInput = document.getElementById('api-key');
  const providerSelect = document.getElementById('provider-select');

  let voices = [];

  function populateVoices() {
    voices = synth.getVoices();
    const langs = [...new Set(voices.map(v => v.lang))];

    // Ensure ur-PK and ur-IN are included manually if missing
    if (!langs.includes('ur-PK')) langs.push('ur-PK');
    if (!langs.includes('ur-IN')) langs.push('ur-IN');

    languageSelect.innerHTML = langs.map(l => `<option value="${l}">${l}</option>`).join('');
    languageSelect.value = localStorage.getItem('tts-language') || 'en-US';
    updateVoiceList();
  }

  function updateVoiceList() {
    const selectedLang = languageSelect.value;
    const filtered = voices.filter(v => v.lang === selectedLang);
    voiceSelect.innerHTML = filtered.map(v => `<option value="${v.name}">${v.name}</option>`).join('');
    if (filtered.length > 0) voiceSelect.value = filtered[0].name;
  }

  function saveSetting(key, value) {
    localStorage.setItem(key, value);
  }

  function loadSettings() {
    if (localStorage.getItem('tts-theme') === 'dark') {
      document.body.classList.add('dark-theme');
      themeCheckbox.checked = true;
    }
    rate.value = localStorage.getItem('tts-rate') || 1;
    pitch.value = localStorage.getItem('tts-pitch') || 1;
    rateVal.textContent = rate.value;
    pitchVal.textContent = pitch.value;
  }

  // Event handlers
  languageSelect.onchange = () => {
    saveSetting('tts-language', languageSelect.value);
    updateVoiceList();
  };
  voiceSelect.onchange = () => saveSetting('tts-voice', voiceSelect.value);
  rate.oninput = () => {
    rateVal.textContent = rate.value;
    saveSetting('tts-rate', rate.value);
  };
  pitch.oninput = () => {
    pitchVal.textContent = pitch.value;
    saveSetting('tts-pitch', pitch.value);
  };
  themeCheckbox.onchange = () => {
    document.body.classList.toggle('dark-theme');
    saveSetting('tts-theme', themeCheckbox.checked ? 'dark' : 'light');
  };

  // Speak
  document.getElementById('speak-btn').onclick = () => {
    if (synth.speaking) return alert('Already speaking');
    const utter = new SpeechSynthesisUtterance(textInput.value);
    utter.voice = voices.find(v => v.name === voiceSelect.value);
    utter.rate = rate.value;
    utter.pitch = pitch.value;
    synth.speak(utter);
  };

  // Playback controls
  document.getElementById('pause-btn').onclick = () => synth.pause();
  document.getElementById('resume-btn').onclick = () => synth.resume();
  document.getElementById('cancel-btn').onclick = () => synth.cancel();

  // Download button
  document.getElementById('download-btn').onclick = async () => {
    const text = textInput.value.trim();
    const provider = providerSelect.value;
    const key = apiKeyInput.value.trim();
    const lang = languageSelect.value;

    if (!text) return alert('Please enter some text.');

    if ((provider === 'voicerss' || provider === 'elevenlabs') && !key) {
      alert('API key required for selected provider');
      return;
    }

    if (provider === 'voicerss') {
      const url = `https://api.voicerss.org/?key=${key}&hl=${lang}`
                + `&r=${Math.round((rate.value - 1) * 10)}&c=MP3&f=44khz_16bit_stereo`
                + `&src=${encodeURIComponent(text)}`;
      downloadFromUrl(url, 'voicerss-tts.mp3');
      return;
    }

    if (provider === 'elevenlabs') {
      try {
        const res = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${KISHAN_VOICE_ID}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'xi-api-key': key
          },
          body: JSON.stringify({ text })
        });
        if (!res.ok) throw new Error(await res.text());
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        downloadFromUrl(url, 'kishan-tts.mp3');
      } catch (err) {
        alert('ElevenLabs Error: ' + err.message);
      }
      return;
    }

    alert('Download not supported with Web Speech API. Try VoiceRSS or ElevenLabs.');
  };

  function downloadFromUrl(url, filename) {
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  // Init
  loadSettings();
  populateVoices();
  if (!synth.onvoiceschanged) setTimeout(populateVoices, 500);
  else synth.onvoiceschanged = populateVoices;
</script>
